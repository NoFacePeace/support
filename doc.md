# 毕业论文

## 摘要

随着互联网技术的普及，各种类型的系统被搭建且用于解决实际问题。它们组成的系统群是企业组成的重要部分。对于非技术人员来说，人性化的页面和简易的操作能够帮助他们快速的熟悉系统操作并进行相关的业务处理。然而，对于开发者来说，面对大量的系统，特别是与开发有关的系统，每次打开浏览器，输入登录信息，进行页面操作是一种反复重复性的行为，严重浪费时间且降低开发效率。开发者更希望能够在 shell 通过输入命令的方式去处理事情。
因此，思考一种解决方案，让开发者能够以一种类似输入命令一样的方式去处理系统的业务变得至关重要，这正是本课题研究的目的和意义。
协同工具基本是每个开发团队都会配备的工具，能解决基本的通讯问题。除此之外，还能集成第三方命令。这个架构在协同工具的支撑系统，实际上是一些命令的集合，是协同工具里集成的命令的实现，每个命令对接每个不同的系统，从而让开发者能够在这个协同工具上通过输入命令的方式去处理各类系统的业务，降低开发者的沟通成本以及提高开发者的开发效率，满足敏捷开发的需求。

## 关键字

协同工具 支撑系统 命令 系统集

## 目录

## 绪论

### 研究背景

随着互联网的普及以及 Web 技术的广泛使用，具备一定规模的公司都会在公司内部部署属于自己公司的局域网，特别是大小型的互联网公司。并在局域网内搭建各种各样用于不同用途的管理系统或者 Web 服务。对于通用的管理系统，受众大部分是非技术人员。对于他们来说，人性化的页面和简易的操作能够帮助他们快速的熟悉系统操作并进行相关业务的处理，能极大地提高工作效率。
然而，有些系统是专门为开发者服务的，例如：数据库管理系统、项目上线系统、Bug提报系统、代码管理系统......诸如此类跟开发相关联的系统，对于开发者而言，
每次打开浏览器，输入登录信息，进行业务操作是一种重复性的动作，严重浪费时间和精力，降低开发效率。作为一名合格的开发者，我们的目标是要把日常重复性的工作交给计算机去完成，解放人力，把更多的时间、更多的精力花费技术难关的攻克上。此外，这种辅助开发用的系统一般不是自闭的，也就是说，需要多个人协同去完成整个流程或业务。如果一个人处理完之后，还得去联系另一个人，这无疑增加沟通成本
鉴于以上的需求，思考一种行之有效的思路，提供一种可行的方案是至关重要的。经过了长达三个月的实习经历，以及期间 leader 和指导老师给予我的建议和指导，我总结出了通过某种协同工具，配套一个自己实现的支撑系统来串联各种其他开发系统的方案，并为之展开设计和实现。

### 解决方案

对于开发者团队来说，团队协作工具通常是必备的开发工具，最基本的功能包括通讯功能，可以有效的降低沟通成本，市面上常见的通讯工具诸如微信、QQ等，数据都是保存在服务商的服务器上，做不到数据的安全，也容易造成数据的丢失，最重要的一点是这类工具的扩展性极差，且开发者基本无法对这类工具进行扩展，用户就无法实现自定义的设计需求，仅仅只能用于通讯。对于普通用户来说，可能能够支持通讯就足够了。然而，对于开发者来说，这远远不够。开发者所需要的不仅仅是通讯，还希望在此之上能够根据自己的需求，实现自定义功能以及集成第三方的工具等等可扩展的功能。国外有许多诸如之类的优秀产品，后面我使用的团队协作工具 Mattermost 就是其中一种，不仅提供了通讯功能，还集成了多种可供选择的开发工具，也允许用户自定义命令。
架构在协同工具 Mattermost 的支撑系统，实际上是集成在协同工具上命令的具体实现，是一系列自动化脚本的集合。这些脚本对接相应的系统，通过命令调用，去处理相关的业务。最终实现的效果是，在协同工具上输入命令以及相应的参数，协同工具向支撑系统发起 Http 请求，支撑系统接收到请求后，解析请求，对接相应的系统，处理业务操作。从而代替我们在页面执行的操作，省去了浏览的时间以及进行页面操作等重复性的动作。
该课题最好的实践场景是在公司内部，因为公司有自己专属的局域网以及各种类型的系统去集成。然而，在公司外部的网络无法去连接公司内网，所以只能把学校作为实践场景，学校有图书馆系统、校园一卡通、个人信息门户系统，其中有查看个人信息功能、查看课程以及查看成绩功能，另外集成了发邮件的功能以及个人备忘录。

## 关键技术和工具介绍

本章节主要对毕业设计中涉及到的技术栈和相关工具作一个罗列以及简单的介绍。包括：协同工具 Mattermost、编程语言 Python、Web 框架 Flask、爬虫工具库 Beautiful Soup以及 钩子Webhook

### Mattermost

目前国外比较流行的团队协作工具是一个叫做 Slack 的产品，Slack 主要的功能包括聊天群组、大规模工具集成、文件整合以及统一搜索。截止2014年底，Slack已经整合了电子邮件、短信、Google Drives、Twitter、Trello、Asana、Github等65种工具和服务，已经可以把各种碎片化的企业沟通和协作集中到一起。
然而，Slack 是一个商业产品，本身对外收费，不是开源产品，且服务必需搭建在服务商的服务器上。这样数据文件就不能自己控制了，并且服务器在国外，对于国内的情况，情况更是不容乐观，因为国外的服务器可能存在被墙掉的可能性。
Mattermost 是一个 Slack 的开源替代品。Mattermost 采用 Go 语言开发，这个一个开源的团队通讯服务。为团队带来跨 PC 和移动设备的消息、文件分享，提供归档和搜索功能。同时能提供接入第三方服务，这能完美接入我将要设计的第三方支撑系统。

### Python

Python 是一门现代的高级编程语言，它的定位是”优雅“、”明确“、”简单“，虽然 Python 程序看上去简单易懂，但去支持广泛的应用程序开发，从简单的文字处理到WWW浏览器在到游戏，都有Python的用武之地。虽然Python一直被人们诟病它的运行速度、性能方面的问题。然而对于写一些工具或自动化脚本来说，由于使用用户是少部分人，所以性能问题固然重要，但并不是最主要的问题，可以暂时不用去考虑它。因而将 Python 作为实现设计的支撑系统的编程语言。

### Flask

Flask是一个轻量级的Web微框架，它仅仅实现了Web应用的核心功能：Flask由两个主要依赖组成（提供路由、调试和Web服务器网关接口的Werkzeug和提供模板的Jinja2），对于开发的支撑系统，这两个组成已经满足开发需求了。除此之外，Flask包括了良好的文档、丰富的插件、包含开发服务器和调试器（debugger）、集成支持单元测试、RESTful请求调度、支持安全cookies、基于Unicode这些特点，能够有效加快支撑系统的开发和实现。

### Beautiful Soup

Beautiful Soup 是 Python 的一个第三方库，最主要的功能是从网页上抓取数据。Beauti Soup 提供一些简单的、Python式的函数用来处理导航、搜索、修改分析树等功能。它是一个工具箱，通过解析文档为用户提供需要抓取的数据，因为简单，所以不需要多少代码就可以写出一个完整的应用程序。
Beautiful Soup自动将输入文档转换为Unicode编码，输出文档转换为utf-8编码。你不需要考虑编码方式，除非文档没有指定一个编码方式，这时，Beautiful Soup就不能自动识别编码方式了。然后，你仅仅需要说明一下原始编码方式就可以了。
Beautiful Soup已成为和lxml、html6lib一样出色的python解释器，为用户灵活地提供不同的解析策略或强劲的速度。

### Webhook

Webhook 就是用户通过自己写的回调函数的方式来改变 Web 应用的一种行为，这些回调函数可以由不是该 Web应用官方的第三方用户或者开发人员来维护，修改。通过使用 Webhook，我们可以自定义一些行为通知到指定的 URL去。Webhook的自己实现的的回调函数通常是由一些事件触发的，比如提交代码到代码库或者博客中新增了一个评论，源网站会为 Webhook 进行 Http 请求的 URI 配置。用户通过配置，就可以是一个网站上的事件调用在另一个网站上表现出来，这些事件调用可以是任何事件，但通常应用的是系统集成和消息通知。

## 系统的分析和设计

支撑系统作为协作工具 Mattermost 和各种各样系统的中间层，是最为关键的一环。本章将详细介绍三方是如何串联在一起的，以及包含了哪些命令，这些命令具体有什么功能，如何去实现的。

### 系统的概览

#### 架构图

#### 流程描述

开发者在 Mattermost 客户端的聊天窗口中输入命令，Mattermost后台发送请求给支撑系统，支撑系统解析请求，分隔参数，再根据不同的命令及相应的参数去调用相对应的脚本工具去执行，亦或获取相关联系统的信息，亦或代替某些页面上的操作

### 功能需求

该支撑系统的实践场景是设置在学校，虽然学校没有企业那么多系统或Web服务，不能体现出该支撑系统的优势。但是也有一些系统可以用于集成的实践。比如学校的门户系统、图书馆系统以及校园一卡通系统。除此之外我还在支撑系统上集成了发邮件的功能、待办事务功能。总共有七个不同的命令，这些命令组成了命令集就是这个系统的主要功能，每个命令关联一个自动化的处理脚本。

### 命令的详细说明

#### 命令：bind

1. 用途：一般 Web 系统都有登录、登出功能，用户只有登录了系统，才有权限在系统上进行相关联的操作，bind 命令就是在你执行这些操作时候，先绑定你的账号，这样你才有权限去执行相关的操作。bind 需要用户去提供有效的账号和密码。

1. 用法：input>/bind <username> <password>

1. 示例如下：

1. 参数说明：

（1）<username>:学号
（2）<password>:密码

#### 命令：todo

1.用途：todo 命令用于实时记录待办的事务，存入数据库中，作为数据的持久层。功能包括事务的添加、事务是否完成状态的调整，事务的删除

1. 关系模式

1. 用法：input>/todo  <parameter> <parameter> ...

1. 示例如下：

1. 参数说明：

（1）<null>:获取所有的事务
（2）/todo create <title> <description>:创建一个新的待办事务
（3）/todo update <id>:把待办事务id的状态更新为已完成
（4）/todo detele <id>:把待办事务id从队列中删除

#### 命令：email

1. 用途：email 命令使我们能够不用登录客户端去发邮件，它本身使用网易的 SMTP邮箱服务器，把发送的信息转换成邮件发送到对方的邮箱内

1. 用法：input>/email <receiver> <subject> <text>

1. 示例如下：

1. 参数说明：

（1）<receiver>:发送邮件的接受者
（2）<subject>:邮件的主题
（3）<text>: 邮件的正文

#### 命令：grade

1.用途：grade 命令对接学校的信息门户的系统，根据绑定人的学号，获取大学各个学年的成绩

1.用法：input>/grade <year>

1.示例如下：

1.参数说明：

（1）<null>：返回大学四个学年的所有选修必修的成绩
（2）<year>: 返回指定学年的成绩

#### 命令：library

1.用途：library 命令对接学校的图书馆系统，获取当前用户的当前借阅记录、历史借阅记录，以及包含查找图书的功能

1.用法：input>/library <parameter> <parameter> ...

1.示例如下：

1.参数说明：

（1）<null>: 返回当前借阅的书籍
（2）/library history: 返回历史借阅的书籍
（3）/library search <name>： 查找相关的书籍

#### 命令：course

1.用途：course 命令同样是对接学校的门户系统，能够查看大学四年选修课程的情况

1.用法：input>/course <year> <week>

1.示例如下：

1.参数说明：

（1）<null>:返回当前学年的所有课程
（2）<year>:返回指定学年的所有课程
（3）<week>:返回指定周数的所有课程

#### 命令：card

1.用途：card 命令主要是对接学校的校园一卡通系统，功能包括了能够查看校园卡余额以及查看当日交易的记录

1.用法：input>/card <history> | <null>

1.示例如下：

1.参数说明：

（1）<null>：返回当前用户校园卡的余额
（2）<record>:返回校园一卡通单日交易的记录

## 命令脚本的实现

### 会话保持

#### 问题

Http协议是无状态的协议，当一次请求结束后，客户端与服务端之间的连接就会断开。下次服务端再次接收到客户端发起的请求时，服务端根本不知道这个请求是哪个用户发送过来的。对于设计的支撑系统来说，需要通过学号和密码去登录相应的系统。所以对于设计的系统而言，它是需要有状态管理的，以便当通过 bind 命令绑定学号和密码后，当下一次客户端发起请求的时候，服务端能够准确的知道Http请求是哪个用户发起的，从而判断相应的学号和密码去登录系统。
传统的会话管理是通过 cookie + session 的方式去管理的，然而对于设计的支撑系统而言，却出现一个问题，请求不是由浏览器发起的，而是协作工具 Mattermost 发起的。浏览器发起请求时，如果存在请求域名对应的 cookie，会自动把cookie放入Http报文里，传给服务端，而协作工具 Mattermost 发起的请求并不会携带 cookie 发送给服务端。为此，需要思考另一种方式去维护会话管理。

#### 解决方案

所幸的是，协同工具 Mattermost 每次向第三方应用发起请求的时候，都会携带一个与当前用户相绑定且唯一的 token。基于这个唯一的 token，可以在支撑系统里设计另一种会话管理的方式。
首先，当协作工具 Mattermost 通过 bind 命令绑定当前用户的账号和密码的时候，在支撑系统里，创建一个键值对类型的数组，存在内存里，key 值就是这个唯一的 token，value 值就是账号和密码。
当用户输入命令，发起请求时，脚本提取 token，检测在内存数组中有没有这个token 作为 key 值的键值对。如果没有，返回数据提示用户先绑定账号和密码。如果存在该键值对，再通过该value值里的账号和密码，去登录系统执行相应的操作。

#### 示例代码

### 模拟登录

#### 问题

上述问题解决了协同工具与支撑系统的会话管理，然而，支撑系统的命令大部分都是要对接其他各种系统，这之间同样需要会话管理，支撑系统同样无法自动为请求附加cookie。学校的系统大部分都是基于 cookie和 session 的方式保持彼此间的会话的，因为它们默认发起请求的客户端是浏览器。所以支撑系统得设计出一种方面，模拟这种 cookie 和session的方式来与系统保持会话。

#### 解决方案

浏览器能够自动把cookie附加进请求报文里，支撑系统的脚本无法完成自动化，所以需要手动去完成这个操作，把cookie保存下来。当脚本发起第一次请求的时候，服务端返回相对应的响应报文，脚本提前响应报文里的cookie，保存在内存上，下一次发起请求时，手动把cookie添加进请求报文里，就可以实现会话管理。
Requests 是 Python 的一个优秀的第三方库，它提供了很多功能特性，几乎涵盖了当今Web服务的所有需求，所有用这个库可以很方便的实现我们的需求。

#### 示例代码

### 抓取数据

#### 问题

由于学校的系统并没有对外提供数据接口，所以每次发起请求后，返回的数据是一个完整的Html文件，因此，我们需要对html文件做个清洗和处理。

#### 解决方面

Beautiful Soup同样也是一个 Python 的优秀第三方库，它提供一种非常简易的方式从HTML或XML文件中提取你所需要的数据。这恰好解决了支撑系统处理HTML
文件的问题。以下是实现的脚本从HTML文件从抓取数据的示例

#### 示例代码

## 项目系统的部署和上线

###生产环境

1.操作系统:Ubuntu Server 16.04.1 LTS 64位
2.CPU:	1核
3.内存:	1GB
4.系统盘:50 GB（本地硬盘）
5.公网带宽:1Mbps

### 协同工具Mattermost的部署
1. 下载 Mattermost
wget https://releases.mattermost.com/X.X.X/mattermost-X.X.X-linux-amd64.tar.gz
2. 解压文件
    tar -xvzf mattermost*.gz
3. 移动项目到有权限的目录
    sudo mv mattermost /home/<user_name>
4. 创建存储目录文件
    sudo mkdir /home/<user_name>/mattermost/data
5. 配置数据库
    # ~/mattermost/config/config.json
    "DriverName" "mysql",
    "DataSource": "<user_name>:<user_password>@tcp(<host-name-or-IP>:3306)/mattermost?charset=utf8mb4,utf8&readTimeout=30s&writeTimeout=30s"
6. 创建数据库
    create database mattermost;
    exit;
7. 创建 Systemd 配置文件
    sudo touch /lib/systemd/system/mattermost.service
 
8. 编辑配置文件
    [Unit]
    Description=Mattermost
    After=network.target
    After=mysql.service
    Requires=mysql.service

    [Service]
    Type=simple
    ExecStart=~/mattermost/bin/platform
    Restart=always
    RestartSec=10
    WorkingDirectory=~/mattermost
    User=<user_name>
    Group=<user_group>
    LimitNOFILE=49152

    [Install]
    WantedBy=mysql.service
9. Systemd 加载新的单元
    sudo systemctl daemon-reload
10. 检测单元是否加载
    sudo systemctl status mattermost.service
11. 启动服务
    sudo systemctl start mattermost.service
11. 设置开机启动
    sudo systemctl enable mattermost.service
### 支撑系统的部署
1.从远程仓库拉取代码
Git clone <代码地址>
2.创建Python虚拟环境
Virtualenv venv
3.安装第三方包
Pip install flask request
4.启动程序
Python server.py

## 总结

通过此次毕业设计，我收获到的东西了很多。我明白了，要想成为一名合格的开发者，首先要有开源的精神，要经常去接触一些优秀的开源项目，去翻看他们的源码，学习他人解决问题的思路以及编写代码的良好习惯。同时，要时常留意开发过程中一些重复性的工作，一些需要反复进行的操作，把这些操作能不能实现成工具或自动化脚本，交由计算机去执行。这样能够有效地解放人力，从而把更多的时间和精力投放到技术难关的攻克上。
之后，我们可以把这些脚本提交到开发者社区里供其他开发者使用，听取其他开发者的意见，不断去改善它，优化它，加强和完善它的功能。经过长时间版本的不断迭代，你的开源工具就会从一个小小的工具变成了一个优秀的开源项目，在国内或者其他国家甚至在世界上流行开来，从而成为流行于世界受人欢迎的产品，也许你就会成为下一个马克扎克伯格。

## 致谢

首先，感谢我大学四年来的所有老师，感谢他们的耐心教导，使我掌握了扎实的计算机理论知识，让我学会了各种实用的计算机技能以及不断去探索、不断去求知的精神。
接着要感谢我毕业论文的指导老师-高文宇老师，感谢他的宽容和体谅。由于我自己没能合理地分配实习时间和完成毕业设计的时间，导致我的毕业论文在各节点都没能按时完成，但老师很耐心地在方方面面指导我，给予我帮助和建议，使我能更快地提高完成毕业设计的进度。
最后要感谢在我实习期间里不断给予我关照和指点的 leader 和同事们，他们的意见是我能完成这次毕业设计不可或缺的一部分。同时，他们也为我打开了开发者世界新的大门，让我有机会能够参与到一个完整项目的开发中，熟悉一个项目从提出需求、系统设计、代码实现、功能测试以及项目的部署和上线整个开发流程。当然，也督促我去改变一些不良的编码习惯，促使我去养成良好的编码习惯。除此之外，还使我开阔视野，认识到很多优秀、有趣的开源项目。
毕业设计是作为大学生，整个大学生涯最后一次考核，希望能够顺顺利利地通过。

## 参考文献